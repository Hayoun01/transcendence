services:
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: frontend
    env_file:
      - ./services/frontend/.env
    networks:
      - transcendence-network
    depends_on:
      - api_gateway
    volumes:
      - logs-volume:/usr/src/logs
  api_gateway:
    build:
      context: ./services/api_gateway
      dockerfile: Dockerfile
    container_name: api_gateway
    depends_on:
      - auth
      - tournament
      - user-mgmt
      - chat
      - notification
      - game_backend
      - skyjo_backend
    env_file:
      - ./.env.shared
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
  auth:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: auth
    depends_on:
      rabbit:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - NODE_ENV=production
    env_file:
      - ./.env.shared
      - ./services/auth/.env
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
      - auth-db:/usr/src/app/prisma
  tournament:
    build:
      context: ./services/tournament
      dockerfile: Dockerfile
    container_name: tournament
    depends_on:
      rabbit:
        condition: service_healthy
    env_file:
      - ./.env.shared
      - ./services/tournament/.env
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
      - tournament-db:/usr/src/app/prisma
  user-mgmt:
    build:
      context: ./services/user-mgmt
    container_name: user-mgmt
    depends_on:
      rabbit:
        condition: service_healthy
    env_file:
      - ./.env.shared
      - ./services/user-mgmt/.env
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
      - user-mgmt-db:/usr/src/app/prisma
      - uploads-data:/usr/src/app/uploads
  chat:
    build:
      context: ./services/chat
    container_name: chat
    env_file:
      - ./.env.shared
      - ./services/chat/.env
    depends_on:
      rabbit:
        condition: service_healthy
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
      - chat-db:/usr/src/app/prisma
  game_backend:
    build:
      context: ./services/game_backend
    container_name: game_backend
    depends_on:
      rabbit:
        condition: service_healthy
    env_file:
      - ./.env.shared
    environment:
      - NODE_ENV=production
    networks:
      - transcendence-network
    volumes:
      - game-backend-db:/app/data
  skyjo_backend:
    build:
      context: ./services/skyjo_backend
    container_name: skyjo_backend
    environment:
      - NODE_ENV=production
    networks:
      - transcendence-network
    volumes:
      - skyjo-backend-db:/app/data
  notification:
    build:
      context: ./services/notification
    container_name: notification
    depends_on:
      rabbit:
        condition: service_healthy
      user-mgmt:
        condition: service_started
    env_file:
      - ./.env.shared
      - ./services/notification/.env
    networks:
      - transcendence-network
    volumes:
      - logs-volume:/usr/src/logs
  redis:
    image: redis:7-alpine
    container_name: redis
    networks:
      - transcendence-network
    volumes:
      - redis-data:/data
  rabbit:
    image: rabbitmq:3-management
    container_name: rabbit
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "status"]
      interval: 5s
      timeout: 5s
      retries: 50
    networks:
      - transcendence-network
    volumes:
      - rabbit-data:/var/lib/rabbitmq
  prometheus:
    depends_on:
      - cadvisor
      - node_exporter
    restart: unless-stopped 
    container_name: prometheus
    build: ./services/prometheus/.
    networks:
      - monitoring-network
    volumes:
      - prometheus-data:/prometheus
  grafana:
    depends_on:
      - prometheus
    restart: unless-stopped 
    container_name: grafana
    build: 
      context: ./services/grafana/.
      secrets:
        - admin_password
    networks:
      - monitoring-network
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    networks:
      - monitoring-network
    pid: host
    restart: unless-stopped
    volumes:
      - '/:/host:ro'
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    volumes:
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/sys:ro"
      - "/var/lib/docker/:/var/lib/docker:ro"
      - "/dev/disk/:/dev/disk:ro"
    devices:
      - "/dev/kmsg:/dev/kmsg"
    networks:
      - monitoring-network
    restart: unless-stopped
  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "3000:3000"
      - "5601:5601"
      - "9090:9090"
      - "6969:6969"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - transcendence-network
      - monitoring-network
      - elk-network
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.http.ssl.enabled=false
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=123456
    healthcheck:
      test: curl -s http://localhost:9200 >/dev/null || exit 1
      interval: 5s
      timeout: 5s
      retries: 50
    ulimits:
      memlock: { soft: -1, hard: -1 }
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - elk-network
  
  logstash:
    image: docker.elastic.co/logstash/logstash:8.17.0
    container_name: logstash
    environment:
      - "LS_JAVA_OPTS=-Xms512m -Xmx512m"
      - ELASTIC_PASSWORD=123456
    volumes:
      - ./elk/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./elk/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
    networks:
      - elk-network
    depends_on:
      elasticsearch:
        condition: service_healthy
  
  setupelastic:
    container_name: setupelastic
    image: curlimages/curl:latest
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: "no"
    entrypoint: 'curl -X POST http://elasticsearch:9200/_security/user/kibana_system/_password -H "Content-Type: application/json" -d "{\"password\": \"123456\"}" -u elastic:123456'
    networks:
      - elk-network
  
  kibana:
    image: docker.elastic.co/kibana/kibana:8.17.0
    container_name: kibana
    volumes:
      - ./elk/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml
    environment:
      - KIBANA_USERNAME=kibana_system
      - KIBANA_PASSWORD=123456
      - KIBANA_ENCRYPTION_KEY=uhduiha89hd8uhduiha89hd8uhduiha8
      - KIBANA_OBJ_ENCRYPTION_KEY=a7a6311933d3503b89bc2dbc36572c33a6c10925682e591bffcab6911c06786d
    networks:
      - elk-network
    depends_on:
      elasticsearch:
        condition: service_healthy

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.17.0
    container_name: filebeat
    user: root
    volumes:
      - logs-volume:/var/log/fastify:ro
      - ./elk/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
    networks:
      - elk-network
    depends_on: 
      - logstash
    command: >
      filebeat -e -c /usr/share/filebeat/filebeat.yml --strict.perms=false

networks:
  transcendence-network:
    name: transcendence-network
    driver: bridge
  monitoring-network:
    name: monitoring-network
    driver: bridge
  elk-network:
    name: elk-network
    driver: bridge

volumes:
  logs-volume:
    name: logs-volume
    driver: local
  redis-data:
    name: redis-data
    driver: local
  rabbit-data:
    name: rabbit-data
    driver: local
  auth-db:
    name: auth-db
    driver: local
  tournament-db:
    name: tournament-db
    driver: local
  user-mgmt-db:
    name: user-mgmt-db
    driver: local
  chat-db:
    name: chat-db
    driver: local
  game-backend-db:
    name: game-backend-db
    driver: local
  skyjo-backend-db:
    name: skyjo-backend-db
    driver: local
  uploads-data:
    name: uploads-data
    driver: local
  prometheus-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  es-data:
    name: es-data
    driver: local

secrets:
  admin_password:
    file: ./secrets/admin_password
